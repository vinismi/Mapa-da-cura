
"use client";

import { useState, useEffect } from "react";
import { ChatLayout } from "@/components/chat/chat-layout";
import { generatePersonalizedResponse, checkForNameCorrection, type NameCorrectionCheckOutput } from "@/ai/flows/personalized-response-flow";
import { useToast } from "@/hooks/use-toast";
import type { Message } from "@/lib/types";
import { StatusView } from "@/components/chat/status-view";
import { Button } from "@/components/ui/button";
import { ChevronRight, Send, Sparkles } from "lucide-react";

export default function Home() {
  const [messages, setMessages] = useState<Message[]>([]);
  const [isTyping, setIsTyping] = useState(false);
  const [userInput, setUserInput] = useState("");
  const [conversationStep, setConversationStep] = useState(0);
  const { toast } = useToast();
  const [userName, setUserName] = useState("");
  const [userMotivation, setUserMotivation] = useState("");
  const [userPainDuration, setUserPainDuration] = useState("");
  const [userAttempts, setUserAttempts] = useState("");
  const [isViewingStatus, setIsViewingStatus] = useState(false);
  const [conversationStarted, setConversationStarted] = useState(false);

  const addMessage = (message: Omit<Message, "id" | "timestamp">) => {
    setMessages((prev) => [
      ...prev,
      { ...message, id: Date.now().toString(), timestamp: new Date() },
    ]);
  };
  
  const showTypingIndicator = async (duration: number) => {
      setIsTyping(true);
      await new Promise(resolve => setTimeout(resolve, duration));
      setIsTyping(false);
  }

  const handleNameCorrection = async (correction: NameCorrectionCheckOutput, text: string, currentQuestion: () => void) => {
    if (correction.isCorrectingName && correction.newName) {
        setUserName(correction.newName);
        await showTypingIndicator(2000);
        addMessage({ sender: "bot", type: "text", content: `Ops, anotado! Vou te chamar de ${correction.newName} entÃ£o. ðŸ˜‰` });
        await showTypingIndicator(3000);
        currentQuestion(); // Re-ask the current question
        return true;
    }
    return false;
  }
  
  const startConversation = async () => {
    setConversationStarted(true);
    addMessage({ sender: "user", type: "text", content: "OlÃ¡! Vi sobre a Jornada e quero saber mais." });
    await showTypingIndicator(3000);
    addMessage({
      sender: "bot",
      type: "audio",
      content: "https://darling-otter-f7bf47.netlify.app/audio.mp3",
      meta: {
        audioText: "OlÃ¡! Que bom que vocÃª veio, tudo bem? Para que a gente se conheÃ§a um pouquinho melhor, como eu posso te chamar?",
      },
    });
    setConversationStep(1); // Move to next step which is waiting for the user's name.
  };


  const handleSendMessage = async (text: string) => {
    if (!text.trim()) return;

    // Don't add automatic messages as user messages
    if (text !== "JÃ¡ vi os status!") {
        addMessage({ sender: "user", type: "text", content: text });
    }
    
    setUserInput("");
    setMessages(prev => prev.map(msg => ({ ...msg, options: undefined })));

    try {
      switch (conversationStep) {
        case 1: // Asked for name in audio
            const name = text.trim();
            const lowerCaseText = text.toLowerCase();

            // Handle if user says "I'm fine" or similar, then ask for name again.
            if (lowerCaseText.includes("tudo bem") || lowerCaseText.includes("estou bem") || lowerCaseText.includes("tudo Ã³timo")) {
                await showTypingIndicator(2000);
                addMessage({ sender: "bot", type: "text", content: "Que Ã³timo! Fico feliz em saber. ðŸ˜Š" });
                await showTypingIndicator(2500);
                addMessage({
                    sender: "bot",
                    type: "text",
                    content: "E para a gente se conhecer melhor, como posso te chamar?",
                });
                // Keep conversationStep at 1 to wait for the name
            } else {
                setUserName(name);
                await showTypingIndicator(4500);
                addMessage({
                    sender: "bot",
                    type: "text",
                    content: `Ã‰ um prazer te conhecer, ${name}! Fico super curiosa... o que te trouxe atÃ© aqui? Me conta qual a sua maior motivaÃ§Ã£o para buscar essa cura espiritual.`,
                });
                setConversationStep(3);
            }
            break;

        case 3: // Asked about motivation
           const motivation = text;
           
           const nameCorrection = await checkForNameCorrection({ previousName: userName, currentInput: text });
           if (await handleNameCorrection(nameCorrection, text, () => {
               addMessage({ sender: "bot", type: "text", content: `Certo, ${nameCorrection.newName}! E qual seria a sua maior motivaÃ§Ã£o para buscar a cura espiritual?` });
           })) return;

           setUserMotivation(motivation);
           
           await showTypingIndicator(5500);
           const empathyResponseForMotivation = await generatePersonalizedResponse({ userInput: `O usuÃ¡rio ${userName} tem a seguinte motivaÃ§Ã£o: "${motivation}". Gere uma resposta de empatia que seja verdadeiramente personalizada e relevante para o que foi dito, sem repetir as palavras do usuÃ¡rio.` });
           addMessage({
             sender: "bot",
             type: "text",
             content: empathyResponseForMotivation.personalizedResponse
           });

           await showTypingIndicator(4800);
           addMessage({ sender: "bot", type: "text", content: "E me diga uma coisa, hÃ¡ quanto tempo vocÃª sente que essa Ã¡rea da sua vida precisa de um carinho especial?" });
          
          setConversationStep(4);
          break;
        
        case 4: // Asked about pain duration
            const duration = text;
            setUserPainDuration(duration);

            await showTypingIndicator(5500);
            addMessage({
                sender: "bot",
                type: "text",
                content: `Uau, Ã© um tempinho, nÃ©? Carregar esse peso todo nÃ£o Ã© fÃ¡cil.`,
            });
            
            await showTypingIndicator(4200);
            addMessage({ sender: "bot", type: "text", content: "Mas olha, muitas pessoas incrÃ­veis que converso sentem o mesmo. VocÃª nÃ£o estÃ¡ sozinha nessa, de verdade." });
            
            await showTypingIndicator(4800);
            addMessage({
              sender: "bot",
              type: "text",
              content: `E ${userName}, me conta, vocÃª jÃ¡ tentou alguma coisa pra dar um jeito nisso? Como foi?`
            });
            setConversationStep(5);
            break;
            
        case 5: // Asked about previous attempts
            const attempts = text;
            setUserAttempts(attempts);

            await showTypingIndicator(6000);
             const empathyResponse2 = await generatePersonalizedResponse({ userInput: `O usuÃ¡rio ${userName} jÃ¡ tentou o seguinte para resolver seu problema: "${attempts}". Mostre que vocÃª entende e que muitas tentativas podem ser frustrantes, mas que hÃ¡ um caminho. Use uma linguagem amigÃ¡vel e um pouco de humor, como se estivesse conversando com uma amiga.` });
            addMessage({
                sender: "bot",
                type: "text",
                content: empathyResponse2.personalizedResponse,
            });

            await showTypingIndicator(4800);
            addMessage({
                sender: "bot",
                type: "text",
                content: `Qual foi a Ãºltima vez que vocÃª se sentiu 100% conectada e em paz, daquele jeito que a gente atÃ© suspira?`,
            });
            setConversationStep(6);
            break;

        case 6: // Answered last time felt connected
            await showTypingIndicator(4800);
            addMessage({
                sender: "bot",
                type: "text",
                content: `Obrigada por abrir seu coraÃ§Ã£o. Ã‰ super importante a gente se lembrar desses momentos bons. Tenho uma coisinha que pode te inspirar...`
            });
            await showTypingIndicator(3500);
            addMessage({
                sender: "bot",
                type: "status",
                content: "Preparei umas histÃ³rias lindas nos meus status, de gente que, como a gente, buscou e achou um novo brilho. DÃ¡ uma espiadinha lÃ¡ e me diz o que achou!",
            });
            setConversationStep(7);
            break;

        case 7: // After Status
            if (text === "Ver status") {
                setIsViewingStatus(true);
                return; 
            }
            
            if (text === "JÃ¡ vi os status!") {
              await showTypingIndicator(4500);
              addMessage({ sender: "bot", type: "text", content: `E aÃ­, nÃ£o Ã© de arrepiar? Ver a histÃ³ria de outras pessoas renova nossas forÃ§as, nÃ©?` });
              
              await showTypingIndicator(5000);
              addMessage({ sender: "bot", type: "text", content: `Alguma daquelas histÃ³rias mexeu com vocÃª de um jeito especial?` });
              
              setConversationStep(8);
            }
            break;
        
        case 8: // User reacts to testimonials
              await showTypingIndicator(5000);
              addMessage({ sender: "bot", type: "text", content: `Que bom que vocÃª sentiu essa conexÃ£o! Agora, se prepara, que o universo conspira. Senti de te conectar com uma pessoa que viveu algo parecido com vocÃª... e ela vai te ligar!` });
              
              await showTypingIndicator(4000);
              addMessage({ sender: "bot", type: "text", content: `Ela vai te mostrar um caminho que a ajudou a florescer. Fica atenta!` });

              await showTypingIndicator(3000);
              addMessage({ sender: "bot", type: "live-call", content: "Chamada de VÃ­deo de Luz" });

              setTimeout(async () => {
                  setMessages(prev => prev.filter(m => m.type !== 'live-call'));
                  await showTypingIndicator(4500);
                  addMessage({ sender: "bot", type: "text", content: `Que papo incrÃ­vel! Espero que a energia da Ana tenha te contagiado.` });

                  await showTypingIndicator(5000);
                  addMessage({ sender: "bot", type: "text", content: `${userName}, quero que nossa relaÃ§Ã£o seja de total confianÃ§a, de amiga para amiga. Por isso, vou te dar acesso a TUDO antes mesmo de vocÃª pensar em investir.`});
                  
                  await showTypingIndicator(5000);
                  addMessage({
                      sender: "bot",
                      type: "text",
                      content: "VocÃª vai receber o Mapa da Cura Espiritual completo e todos os bÃ´nus. Se o seu coraÃ§Ã£o vibrar e disser 'Ã© isso!', aÃ­ sim vocÃª realiza o pagamento.",
                  });

                  await showTypingIndicator(4500);
                  addMessage({ sender: "bot", type: "text", content: "Topa seguir nessa base de confianÃ§a mÃºtua?", options: ["Com certeza! Eu topo!", "Como funciona o pagamento?"] });

                  setConversationStep(9);
              }, 15000); // Increased duration for the call
              break;

        case 9: // Access before payment
            if (text.includes("topo")) {
                await showTypingIndicator(4000);
                addMessage({ sender: "bot", type: "text", content: `Maravilha, ${userName}! Sabia que vocÃª era das minhas! Preparei um vÃ­deo rapidinho pra te mostrar o tesouro que vocÃª vai receber:` });

                await showTypingIndicator(3000);
                addMessage({ sender: "bot", type: "video", content: "https://placehold.co/600x400.png", meta: { videoTitle: "Tutorial RÃ¡pido: Desbravando seu Mapa da Cura" } });

                await showTypingIndicator(6000);
                addMessage({ sender: "bot", type: "text", content: "Pensa nesse mapa como seu GPS para a alma. Ele Ã© o resultado de anos de estudo e vivÃªncias, tudo mastigadinho pra vocÃª redescobrir sua forÃ§a, alinhar sua energia e manifestar a vida espetacular que vocÃª merece." });
                
                await showTypingIndicator(5000);
                addMessage({ sender: "bot", type: "bonuses", content: "E como amiga boa nÃ£o deixa na mÃ£o, olha sÃ³ o que vem junto pra turbinar sua jornada:" });
                
                await showTypingIndicator(4500);
                addMessage({ sender: "bot", type: "image", content: "https://placehold.co/600x400.png", dataAiHint:"spiritual map golden light", meta: { title: "Seu Mapa da Cura Espiritual" }});
                
                await showTypingIndicator(6000);
                addMessage({
                    sender: "bot",
                    type: "text",
                    content: `Todo esse material, que jÃ¡ transformou centenas de vidas, jÃ¡ Ã© seu. Mergulhe, sinta, explore. Quando seu coraÃ§Ã£o der aquele pulinho de 'encontrei!', vocÃª finaliza sua inscriÃ§Ã£o com um investimento simbÃ³lico de R$39,99 via PIX. Um valor de cafezinho para uma transformaÃ§Ã£o de vida!`,
                });

                await showTypingIndicator(3500);
                addMessage({ sender: "bot", type: "text", content: "Chave PIX (E-mail): contato@curaespritual.com" });
                addMessage({ sender: "bot", type: "text", content: "Depois disso, sua jornada de transformaÃ§Ã£o estarÃ¡ selada e eu estarei aqui vibrando por cada conquista sua." });

                setConversationStep(10);
            } else { // "Como funciona o pagamento?"
                 await showTypingIndicator(4500);
                 addMessage({ sender: "bot", type: "text", content: `Funciona na base da confianÃ§a! VocÃª recebe acesso a TUDO agora. Explora, usa, sente a transformaÃ§Ã£o. O pagamento de R$39,99 Ã© feito por PIX para a chave contato@curaespritual.com, mas sÃ³ depois que vocÃª sentir que valeu a pena. Sem pressÃ£o!` });
                 await showTypingIndicator(4000);
                 addMessage({ sender: "bot", type: "text", content: `Pronta pra comeÃ§ar essa revoluÃ§Ã£o interior?`, options: ["Com certeza! Eu topo!"]});
                 // Keep step at 9 to handle the "Sim" response next.
            }
            break;
            
        default:
          await showTypingIndicator(3000);
          const genericResponse = await generatePersonalizedResponse({
            userInput: text,
          });
          addMessage({
            sender: "bot",
            type: "text",
            content: genericResponse.personalizedResponse,
          });
          break;
      }
    } catch (error) {
      console.error("Error generating response:", error);
      toast({
        variant: "destructive",
        title: "Erro de ConexÃ£o",
        description:
          "NÃ£o foi possÃ­vel obter uma resposta. Por favor, tente novamente.",
      });
      addMessage({
        sender: "bot",
        type: "text",
        content:
          "Ops, minha bola de cristal tÃ¡ meio embaÃ§ada aqui. A conexÃ£o falhou. Poderia tentar de novo em um instante?",
      });
    } finally {
      setIsTyping(false);
    }
  };

  const handleStatusFinish = () => {
    setIsViewingStatus(false);
    if (conversationStep === 7) {
      // Use a timeout to ensure state update happens after render cycle
      setTimeout(() => handleSendMessage("JÃ¡ vi os status!"), 0);
    }
  };

  if (isViewingStatus) {
    return <StatusView onFinish={handleStatusFinish} />;
  }

  if (!conversationStarted) {
    return (
      <div className="flex h-screen w-full flex-col">
        <div 
          className="flex-1 flex flex-col items-center justify-center text-center p-4 bg-cover bg-center"
          style={{ 
            backgroundImage: "url('/spiritual-bg.png')",
          }}
        >
          <div className="absolute inset-0 bg-black/50" />
            <div className="relative bg-gradient-to-br from-background/90 to-background/70 backdrop-blur-sm p-8 rounded-3xl shadow-2xl max-w-lg border border-white/10">
                <div className="flex justify-center items-center mb-4">
                  <Sparkles className="h-6 w-6 text-primary animate-pulse"/>
                  <h1 className="text-3xl md:text-4xl font-bold text-primary mx-2">
                      Jornada do Despertar Espiritual
                  </h1>
                  <Sparkles className="h-6 w-6 text-primary animate-pulse"/>
                </div>
                <p className="text-foreground/80 mb-8 text-base md:text-lg">
                    Receba orientaÃ§Ã£o personalizada e encontre o caminho para a sua cura interior. Inicie uma conversa e descubra o seu potencial.
                </p>
                <Button size="lg" className="w-full text-lg h-14 rounded-full group bg-primary/90 hover:bg-primary" onClick={startConversation}>
                    Iniciar Conversa Agora
                    <ChevronRight className="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform"/>
                </Button>
            </div>
        </div>
      </div>
    );
  }
  
  return (
    <main className="h-screen max-h-screen">
      <ChatLayout
        messages={messages}
        onSendMessage={handleSendMessage}
        isTyping={isTyping}
        userInput={userInput}
        onUserInput={setUserInput}
      />
    </main>
  );
}

    

    
